
# Php Demo

Php REST demo application.

```sh
git clone git@github.com:olomadev/olobase-demo-php.git
```

Install composer packages

```sh
/var/www/olobase-demo-php$ composer install
```

### Create local.php file in /config/autoload.php

Read the environment configuration in the following link.

<a href="https://oloma.dev/olobase-docs/1.0/php-api/installation.html#Local%20Environment%20Configuration">https://oloma.dev/olobase-docs/1.0/php-api/installation.html#Local%20Environment%20Configuration</a>

```php
<?php

/**
 * Development-only configuration.
 *
 * Put settings you want enabled when under development mode in this file, and
 * check it into your repository.
 *
 * Developers on your team will then automatically enable them by calling on
 * `composer development-enable`.
 */

declare(strict_types=1);

use Laminas\ConfigAggregator\ConfigAggregator;

// echo base64_encode(openssl_random_pseudo_bytes(32)); 
// die;

// $keyPair = sodium_crypto_sign_keypair();
// $publicKey = base64_encode(sodium_crypto_sign_publickey($keyPair));
// $privateKey = base64_encode(sodium_crypto_sign_secretkey($keyPair));

// echo $publicKey."\n";
// echo $privateKey."\n";
// die;

return [
    // Toggle the configuration cache. Set this to boolean false, or remove the
    // directive, to disable configuration caching. Toggling development mode
    // will also disable it by default; clear the configuration cache using
    // `composer clear-config-cache`.
    ConfigAggregator::ENABLE_CACHE => false,

    // Enable debugging; typically used to provide debugging information within templates.
    'debug' => true,
    'token' => [  
        // Cookie encryption
        'encryption' => [
            'iv' => '', // generate random 16 chars string
            'enabled' => true, // it should be true in production environment
            'secret_key' => '',
        ],
        // Public and private keys are expected to be Base64 encoded.
        // The last non-empty line is used so that keys can be generated with
        'public_key' => '',
        // The secret keys generated by other tools may
        // need to be adjusted to match the input expected by libsodium.
        'private_key' => '',
        //
        // for strong security reason it should be less
        'session_ttl' => 15, // in minutes (TTL cannot be less then 10 minute)
        // you can reduce the time for higher security
        // for how long the token will be valid in the app.
        // in every "x" time the token will be refresh. 
        'token_validity' => 5, // in minutes
        // whether to check the IP and User Agent when the token is resolved.
        //
        'validation' => [
            'user_ip' => true,
            'user_agent' => true,
        ],
    ],
    'db' => [
        'driver'   => 'Pdo_Mysql',
        'driver_options' => [
            // PDO::ATTR_PERSISTENT => true,
            // https://www.php.net/manual/tr/mysqlinfo.concepts.buffering.php
            // 
            PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => false,  // should be false

            // https://stackoverflow.com/questions/20079320/php-pdo-mysql-how-do-i-return-integer-and-numeric-columns-from-mysql-as-int
            // 
            PDO::ATTR_EMULATE_PREPARES => false,
            PDO::ATTR_STRINGIFY_FETCHES => false,
            
            // Enable exceptions
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        ],
        'database' => 'demo',
        'hostname' => 'localhost',
        'username' => 'root',
        'password' => '',
        'platform' => 'Mysql',
    ],
    'redis' => [
        'host' => '192.168.231.129',
        'port' => '6379',
        'timeout' => 60,
        'password' => '',
    ]
];
```

### Install Demo.sql

Create a database named <b>demo</b>. Import the demo.sql file which is located in your project root.

### Create a Host Name

Go to your host file

```sh
vim /etc/hosts
```

Give your name host to <b>demo.local</b>. 

```sh
127.0.0.1       localhost
127.0.0.1       demo.local

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

```

Don't forget this value defined in your <b>olobase-demo-ui</b> front-end project <b>.env.local</b> file.

```sh
VITE_API_URL=http://demo.local/api
```

### How to Build Swagger Docs

```
$ /var/www/olobase-demo-php composer swagger
```

<a href="https://medium.com/@tatianaensslin/how-to-add-swagger-ui-to-php-server-code-f1610c01dc03">https://medium.com/@tatianaensslin/how-to-add-swagger-ui-to-php-server-code-f1610c01dc03</a>

## Apache2 Installation

```
sudo a2enmod rewrite
```

vim /etc/apache2/apache2.conf

```
<Directory /var/www/>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
</Directory>
```

Create virtual host

```
cd /etc/apache2/sites-available
cp 00-default.conf demo-php.local.conf
vim demo-php.local.conf
```

Update config

```
<VirtualHost *:80>
        SetEnv "APP_ENV" "local"
        ServerAdmin webmaster@localhost
        ServerName demo-php.local
        DocumentRoot /var/www/demo-php/public
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

Enable vhost and restart apache

```
a2ensite demo-php.local.conf
sudo service apache2 restart
sudo systemctl enable apache2
```

## Php Installation

```
sudo apt install php libapache2-mod-php php-cli
sudo apt install php-common php-mysql php-xml php-curl php-json php-opcache php-mbstring php-intl php-gd php-zip
```

## Installation Redis-Server for Local

<a href="https://tecadmin.net/install-redis-ubuntu-20-04//">https://tecadmin.net/install-redis-ubuntu-20-04/</a>

```
sudo apt update
sudo apt install redis-server
sudo systemctl enable redis-server
sudo apt install php-redis
sudo phpenmod redis
```

```sh
vim /etc/redis/redis.conf
bind 0.0.0.0
protected-mode no
```

Remove all keys

```
redis-cli FLUSHALL
```

To set a password

```
https://stackoverflow.com/questions/7537905/how-to-set-password-for-redis
```


## Installation Redis Desktop Manager

Sign up and download free.

<a href="https://resp.app/">https://resp.app/</a>

## Installation Of MySQL

https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-22-04

## Installation of Composer Packages

```
#var/www/demo-php$ composer install
```

## Tests

All files

```
vendor/bin/phpunit
```

Single file test

```
vendor/bin/phpunit --filter AppointmentHandlerTest
````

## Listening Apache Error Logs

```
tail -n 10 -f /var/log/apache2/error.log
```

## Error Responses

### 404

Response: Status 404 Not Found

```
{
    "title": "Not Found",
    "type": "https://httpstatus.es/404",
    "status": 404,
    "error": "Cannot POST http://va-demo-api/user/create!"
}
```

### Exception

Response: Status 400 Bad Request

```
{
    "title": "Exception Class",
    "file": "App\\src\\Filter\\UserNewFilter.php",
    "line": "115",
    "type": "https://httpstatus.es/500",
    "status": 400,
    "error": "Detailed message",
    "trace": "debug string"
}
```

### Validation errors

Response: Status 400 Bad Request 

```
{
    "error": {
        "email": [
            "Value is required and can't be empty"
        ],
        "password": [
            "Value is required and can't be empty"
        ]
        "photo": [
            "file_id": [
                "Value is required and can't be empty"
            ],
            "file_name": [
                "Value is required and can't be empty"
            ]
        ]
    }
}
```

### Single error

```
{
    "error": {
         "General error",
    }
}
```

### Multiple error

```
{
    "error": {
         ["Error string"],
         ["Another error string"],
    }
}
```
